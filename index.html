<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¤–åŒ…å•†å·¥ç¨‹å·¥æ•¸èˆ‡åŠè»Šçµ±è¨ˆç³»çµ±</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.mini.min.js"></script>

  <!-- Chart.js + Datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

  <style>
    @media print {
      .no-print { display: none !important; }
      body { background: white !important; }
      table { font-size: 14px; }
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen p-4">
  <div id="root"></div>
  <div id="modal-root"></div>

<script type="text/babel">

/* ======================= LocalStorage Helper ======================= */
const load = (k, f) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : f; } catch { return f; } };
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

/* ======================= Modal Componentï¼ˆå…±ç”¨ï¼‰ ======================= */
function Modal({ onClose, children }) {
  return ReactDOM.createPortal(
    <div className="fixed inset-0 bg-black/40 flex justify-center items-center z-50">
      <div className="bg-white p-4 rounded shadow w-80">
        {children}
        <button className="mt-3 bg-gray-500 text-white w-full rounded py-2" onClick={onClose}>
          é—œé–‰
        </button>
      </div>
    </div>,
    document.getElementById("modal-root")
  );
}

/* ======================= ä¸»ç¨‹å¼ App ======================= */
function App() {

  /* -------------------- å·¥ç¨‹ç®¡ç† -------------------- */
  const [projects, setProjects] = React.useState(load("projects", []));
  const [currentProjectId, setCurrentProjectId] = React.useState(load("currentProjectId", ""));
  const [newProject, setNewProject] = React.useState({ number: "", name: "" });

  /* -------------------- å¤–åŒ…å•†ç®¡ç† -------------------- */
  const [vendors, setVendors] = React.useState(load("vendors", ["ç´˜å±•"]));
  const [currentVendor, setCurrentVendor] = React.useState(load("currentVendor", "ç´˜å±•"));
  const [newVendor, setNewVendor] = React.useState("");

  /* -------------------- å·¥æ•¸èˆ‡åŠè»Šç´€éŒ„ -------------------- */
  const [records, setRecords] = React.useState(load("records", []));

  /* -------------------- Modal æ§åˆ¶ -------------------- */
  const [modalType, setModalType] = React.useState("");  // "labor" | "crane" | "edit" | ""

  /* -------------------- æ–°å¢å·¥æ•¸è¡¨å–® -------------------- */
  const [laborForm, setLaborForm] = React.useState({ date:"", labor:"", support:"", note:"" });

  /* -------------------- æ–°å¢åŠè»Šè¡¨å–® -------------------- */
  const [craneForm, setCraneForm] = React.useState({ date:"", spec:"", hr:"", note:"" });

  /* -------------------- ç·¨è¼¯ç´€éŒ„ -------------------- */
  const [editRecord, setEditRecord] = React.useState(null);

  /* =====================================================
          Auto Save
  ===================================================== */
  React.useEffect(() => save("projects", projects), [projects]);
  React.useEffect(() => save("currentProjectId", currentProjectId), [currentProjectId]);
  React.useEffect(() => save("vendors", vendors), [vendors]);
  React.useEffect(() => save("currentVendor", currentVendor), [currentVendor]);
  React.useEffect(() => save("records", records), [records]);

  /* =====================================================
          å¢åŠ å·¥ç¨‹
  ===================================================== */
  const addProject = () => {
    if (!newProject.number || !newProject.name) return;
    const id = Date.now().toString();
    setProjects([...projects, { id, ...newProject }]);
    setCurrentProjectId(id);
    setNewProject({ number:"", name:"" });
  };

  /* =====================================================
          åˆªé™¤å·¥ç¨‹
  ===================================================== */
  const deleteProject = () => {
    if (!currentProjectId) return alert("è«‹å…ˆé¸æ“‡å·¥ç¨‹ï¼");
    const p = projects.find(x => x.id === currentProjectId);
    if (!p) return;

    if (!confirm(`ç¢ºå®šåˆªé™¤å·¥ç¨‹ï¼š${p.number} ${p.name}ï¼Ÿï¼ˆæ‰€æœ‰ç´€éŒ„æœƒè¢«åˆªé™¤ï¼‰`)) return;

    setProjects(projects.filter(x => x.id !== currentProjectId));
    setRecords(records.filter(x => x.projectId !== currentProjectId));
    setCurrentProjectId("");
  };

  /* =====================================================
          æ–°å¢å¤–åŒ…å•†
  ===================================================== */
  const addVendor = () => {
    if (!newVendor.trim()) return;
    if (vendors.includes(newVendor)) return;
    setVendors([...vendors, newVendor]);
    setCurrentVendor(newVendor);
    setNewVendor("");
  };

  /* =====================================================
          æ–°å¢å·¥æ•¸
  ===================================================== */
  const addLabor = () => {
    if (!laborForm.date) return;
    setRecords([
      ...records,
      {
        id: Date.now(),
        type: "labor",
        projectId: currentProjectId,
        vendor: currentVendor,
        date: laborForm.date,
        labor: Number(laborForm.labor || 0),
        support: Number(laborForm.support || 0),
        spec: "",
        hr: 0,
        day: 0,
        note: laborForm.note || ""
      }
    ]);
    setLaborForm({ date:"", labor:"", support:"", note:"" });
    setModalType("");
  };

  /* =====================================================
          æ–°å¢åŠè»Šï¼ˆHR â†’ å¤©ï¼‰
  ===================================================== */
  const addCrane = () => {
    if (!craneForm.date || !craneForm.spec || !craneForm.hr) return;

    const hr = Number(craneForm.hr);
    const day = parseFloat((hr / 8).toFixed(1));

    setRecords([
      ...records,
      {
        id: Date.now(),
        type: "crane",
        projectId: currentProjectId,
        vendor: currentVendor,
        date: craneForm.date,
        spec: craneForm.spec,
        hr,
        day,
        labor: 0,
        support: 0,
        note: craneForm.note || ""
      }
    ]);

    setCraneForm({ date:"", spec:"", hr:"", note:"" });
    setModalType("");
  };

  /* =====================================================
          é–‹å•Ÿç·¨è¼¯ Modal
  ===================================================== */
  const startEdit = (r) => {
    setEditRecord({ ...r });
    setModalType("edit");
  };
  /* =====================================================
          å„²å­˜ç·¨è¼¯å¾Œç´€éŒ„
  ===================================================== */
  const saveEdit = () => {
    setRecords(records.map(r => r.id === editRecord.id ? editRecord : r));
    setModalType("");
    setEditRecord(null);
  };

  /* =====================================================
          åˆªé™¤ç´€éŒ„
  ===================================================== */
  const deleteRecord = (id) => {
    if (!confirm("ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ")) return;
    setRecords(records.filter(r => r.id !== id));
  };

  /* =====================================================
          ä¾å·¥ç¨‹ + å¤–åŒ…å•†ç¯©é¸ç´€éŒ„
  ===================================================== */
  const projectRecords = records
    .filter(r => r.projectId === currentProjectId && r.vendor === currentVendor)
    .sort((a, b) => a.date === b.date ? a.id - b.id : a.date.localeCompare(b.date));

  /* --- å·¥æ•¸çµ±è¨ˆ --- */
  const totalLabor = projectRecords.filter(r => r.type === "labor").reduce((s, r) => s + r.labor, 0);
  const totalSupport = projectRecords.filter(r => r.type === "labor").reduce((s, r) => s + r.support, 0);
  const totalLaborSum = totalLabor + totalSupport;

  /* --- åŠè»Šçµ±è¨ˆ --- */
  const craneStats = {};
  projectRecords.filter(r => r.type === "crane").forEach(r => {
    if (!craneStats[r.spec]) craneStats[r.spec] = 0;
    craneStats[r.spec] += r.day;
  });

  const currentProject = projects.find(p => p.id === currentProjectId);
  const titleText = currentProject
    ? `${currentVendor} - ${currentProject.number} ${currentProject.name} çµ±è¨ˆè¡¨`
    : "å°šæœªé¸æ“‡å·¥ç¨‹";

  /* =====================================================
          åŒ¯å‡º PDF
  ===================================================== */
  const exportPDF = () => {
    if (!currentProject) return alert("è«‹å…ˆé¸æ“‡å·¥ç¨‹ï¼");
    const element = document.getElementById("pdfArea");

    html2pdf()
      .set({
        margin: 5,
        filename: `${titleText}.pdf`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      })
      .from(element)
      .save();
  };

  /* =====================================================
          åŒ¯å‡º Excelï¼ˆSheetJSï¼‰
  ===================================================== */
  const exportExcel = () => {
    if (!currentProject) return alert("è«‹å…ˆé¸æ“‡å·¥ç¨‹ï¼");
    const wb = XLSX.utils.book_new();

    const sheetData = [
      [titleText],
      [],
      ["æ—¥æœŸ", "å¤–åŒ…å•†", "å¤–åŒ…å·¥", "æ”¯æ´å·¥", "åŠè»Šè¦æ ¼", "å¤©", "å‚™è¨»"],
    ];

    projectRecords.forEach(r => {
      sheetData.push([
        r.date, r.vendor, r.labor || "", r.support || "", r.spec || "",
        r.type === "crane" ? r.day.toFixed(1) : "", r.note || ""
      ]);
    });

    sheetData.push([]);
    sheetData.push(["å¤–åŒ…å·¥å°è¨ˆ", totalLabor]);
    sheetData.push(["æ”¯æ´å·¥å°è¨ˆ", totalSupport]);
    sheetData.push(["å·¥æ•¸åˆè¨ˆ", totalLaborSum]);

    sheetData.push([]);
    sheetData.push(["åŠè»Šçµ±è¨ˆ"]);
    Object.entries(craneStats).forEach(([spec, day]) => {
      sheetData.push([spec, `${day.toFixed(1)} å¤©`]);
    });

    const ws = XLSX.utils.aoa_to_sheet(sheetData);
    ws["!cols"] = [{wch:12},{wch:12},{wch:8},{wch:8},{wch:12},{wch:8},{wch:20}];

    XLSX.utils.book_append_sheet(wb, ws, "çµ±è¨ˆè¡¨");
    XLSX.writeFile(wb, `${titleText}.xlsx`);
  };

  /* =====================================================
          åœ“é¤…åœ– Pie Chart
  ===================================================== */
  const pieRef = React.useRef(null);
  const chartRef = React.useRef(null);

  React.useEffect(() => {
    if (!pieRef.current) return;
    const ctx = pieRef.current.getContext("2d");

    if (chartRef.current) chartRef.current.destroy();

    chartRef.current = new Chart(ctx, {
      type: "pie",
      data: {
        labels: ["å¤–åŒ…å·¥", "æ”¯æ´å·¥"],
        datasets: [{
          data: [totalLabor, totalSupport],
          backgroundColor: ["#3B82F6", "#FBBF24"]
        }]
      },
      plugins: [ChartDataLabels],
      options: {
        plugins: {
          legend: { position: "bottom" },
          datalabels: {
            color: "#000",
            font: { weight: "bold", size: 14 },
            formatter: (val, ctx) => {
              const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
              return total === 0 ? "0%" : ((val / total) * 100).toFixed(1) + "%";
            }
          }
        }
      }
    });
  }, [totalLabor, totalSupport]);

  /* =====================================================
          ä¸»ç•«é¢ UI
  ===================================================== */
  return (
    <div className="max-w-full">

      {/* ========= æ¨™é¡Œ ========= */}
      <h1 className="text-2xl font-bold mb-4">{titleText}</h1>

      {/* ========= å·¥ç¨‹ç®¡ç† ========= */}
      <div className="bg-white p-4 rounded shadow mb-4 no-print">
        <h2 className="font-semibold mb-2">å·¥ç¨‹ç®¡ç†</h2>
        <div className="flex gap-4 items-center mb-2">
          <select
            className="border p-2 rounded"
            value={currentProjectId}
            onChange={e => setCurrentProjectId(e.target.value)}
          >
            <option value="">è«‹é¸æ“‡å·¥ç¨‹</option>
            {projects.map(p => (
              <option key={p.id} value={p.id}>{p.number} - {p.name}</option>
            ))}
          </select>

          <button className="bg-blue-600 text-white px-4 py-2 rounded"
            onClick={() => {
              const num = prompt("å·¥ç¨‹æ¡ˆè™Ÿï¼ˆä¾‹ï¼šA001ï¼‰");
              const name = prompt("å·¥ç¨‹åç¨±");
              if (!num || !name) return;
              const id = Date.now().toString();
              setProjects([...projects, { id, number:num, name }]);
              setCurrentProjectId(id);
            }}
          >æ–°å¢å·¥ç¨‹</button>

          <button className="bg-red-600 text-white px-4 py-2 rounded"
            onClick={deleteProject}
          >åˆªé™¤å·¥ç¨‹</button>
        </div>
      </div>

      {/* ========= å¤–åŒ…å•†ç®¡ç† ========= */}
      <div className="bg-white p-4 rounded shadow mb-4 no-print">
        <h2 className="font-semibold mb-2">å¤–åŒ…å•†ç®¡ç†</h2>
        <div className="flex gap-4 items-center mb-2">
          <select
            className="border p-2 rounded"
            value={currentVendor}
            onChange={e => setCurrentVendor(e.target.value)}
          >
            {vendors.map(v => <option key={v} value={v}>{v}</option>)}
          </select>

          <button className="bg-green-600 text-white px-4 py-2 rounded"
            onClick={() => {
              const v = prompt("æ–°å¢å¤–åŒ…å•†åç¨±");
              if (!v) return;
              if (!vendors.includes(v)) setVendors([...vendors, v]);
              setCurrentVendor(v);
            }}
          >æ–°å¢å¤–åŒ…å•†</button>
        </div>
      </div>

      {/* ========= æ“ä½œæŒ‰éˆ•åˆ— ========= */}
      <div className="flex gap-4 mb-4 no-print">
        <button className="bg-blue-500 text-white px-4 py-2 rounded"
          onClick={() => setModalType("labor")}>æ–°å¢å·¥æ•¸</button>

        <button className="bg-yellow-500 text-white px-4 py-2 rounded"
          onClick={() => setModalType("crane")}>æ–°å¢åŠè»Š</button>

        <button className="bg-gray-700 text-white px-4 py-2 rounded"
          onClick={() => window.print()}>åˆ—å°</button>

        <button className="bg-red-600 text-white px-4 py-2 rounded"
          onClick={exportPDF}>åŒ¯å‡º PDF</button>

        <button className="bg-purple-600 text-white px-4 py-2 rounded"
          onClick={exportExcel}>åŒ¯å‡º Excel</button>
      </div>

      {/* =====================================================
                PDF å€åŸŸï¼ˆæ˜ç´°è¡¨ + çµ±è¨ˆ + åœ“é¤…åœ–ï¼‰
      ===================================================== */}
      <div id="pdfArea">

        {/* æ¨™é¡Œ */}
        <h1 className="text-2xl font-bold mb-4">{titleText}</h1>

        {/* ======= æ˜ç´°è¡¨ ======= */}
        <div className="overflow-x-auto bg-white rounded shadow">
          <table className="w-full border">
            <thead className="bg-gray-200">
              <tr>
                <th className="border px-2 py-1">æ—¥æœŸ</th>
                <th className="border px-2 py-1">å¤–åŒ…å•†</th>
                <th className="border px-2 py-1">å¤–åŒ…å·¥</th>
                <th className="border px-2 py-1">æ”¯æ´å·¥</th>
                <th className="border px-2 py-1">åŠè»Šè¦æ ¼</th>
                <th className="border px-2 py-1">å¤©</th>
                <th className="border px-2 py-1">å‚™è¨»</th>
                <th className="border px-2 py-1 no-print">æ“ä½œ</th>
              </tr>
            </thead>

            <tbody>
              {projectRecords.map(r => (
                <tr key={r.id}>
                  <td className="border px-2 py-1">{r.date}</td>
                  <td className="border px-2 py-1">{r.vendor}</td>
                  <td className="border px-2 py-1">{r.labor || ""}</td>
                  <td className="border px-2 py-1">{r.support || ""}</td>
                  <td className="border px-2 py-1">{r.spec || ""}</td>
                  <td className="border px-2 py-1">{r.type === "crane" ? r.day.toFixed(1) : ""}</td>
                  <td className="border px-2 py-1">{r.note}</td>
                  <td className="border px-2 py-1 no-print">
                    <button className="text-blue-600 mr-2" onClick={() => startEdit(r)}>ç·¨è¼¯</button>
                    <button className="text-red-600" onClick={() => deleteRecord(r.id)}>åˆªé™¤</button>
                  </td>
                </tr>
              ))}

              {/* å°è¨ˆ */}
              <tr className="bg-yellow-100 font-bold text-lg">
                <td className="border px-2 py-2 text-center" colSpan="2">å·¥æ•¸å°è¨ˆ</td>
                <td className="border px-2 py-2 text-blue-700">{totalLabor.toFixed(1)}</td>
                <td className="border px-2 py-2 text-blue-700">{totalSupport.toFixed(1)}</td>
                <td className="border px-2 py-2" colSpan="3"></td>
                <td className="border no-print"></td>
              </tr>
            </tbody>
          </table>
        </div>

        {/* ======= çµ±è¨ˆ + åœ“é¤…åœ– ======= */}
        <div className="bg-white p-6 rounded shadow mt-6 border flex gap-6">
          <div className="flex-1">
            <h2 className="text-xl font-bold mb-4">ğŸ“Š çµ±è¨ˆç¸½è¦½</h2>

            <p className="text-lg">å¤–åŒ…å·¥ï¼š<span className="text-blue-700 font-bold">{totalLabor.toFixed(1)}</span></p>
            <p className="text-lg">æ”¯æ´å·¥ï¼š<span className="text-blue-700 font-bold">{totalSupport.toFixed(1)}</span></p>
            <p className="text-lg">å·¥æ•¸åˆè¨ˆï¼š
              <span className="text-red-700 font-bold">{totalLaborSum.toFixed(1)}</span>
            </p>

            <h3 className="text-lg font-bold mt-4">åŠè»Šçµ±è¨ˆ</h3>
            {Object.keys(craneStats).length === 0 && <p>ç„¡åŠè»Šç´€éŒ„</p>}
            {Object.entries(craneStats).map(([spec, day]) => (
              <p key={spec}>{spec}ï¼š<span className="text-green-700 font-bold">{day.toFixed(1)} å¤©</span></p>
            ))}
          </div>

          {/* åœ“é¤…åœ– */}
          <div className="w-64 h-64 flex justify-center items-center">
            <canvas ref={pieRef}></canvas>
          </div>
        </div>
      </div>

      {/* ====================== å‹•æ…‹ Modal ====================== */}
      {modalType === "labor" && (
        <Modal onClose={() => setModalType("")}>
          <h3 className="text-lg font-bold mb-2">æ–°å¢å·¥æ•¸</h3>

          <input type="date" className="border w-full p-2 rounded mb-2"
            value={laborForm.date}
            onChange={e => setLaborForm({ ...laborForm, date: e.target.value })}
          />

          <input type="number" placeholder="å¤–åŒ…å·¥"
            className="border w-full p-2 rounded mb-2"
            value={laborForm.labor}
            onChange={e => setLaborForm({ ...laborForm, labor: e.target.value })}
          />

          <input type="number" placeholder="æ”¯æ´å·¥"
            className="border w-full p-2 rounded mb-2"
            value={laborForm.support}
            onChange={e => setLaborForm({ ...laborForm, support: e.target.value })}
          />

          <input placeholder="å‚™è¨»"
            className="border w-full p-2 rounded mb-2"
            value={laborForm.note}
            onChange={e => setLaborForm({ ...laborForm, note: e.target.value })}
          />

          <button className="bg-blue-600 text-white w-full py-2 rounded" onClick={addLabor}>
            å„²å­˜
          </button>
        </Modal>
      )}

      {modalType === "crane" && (
        <Modal onClose={() => setModalType("")}>
          <h3 className="text-lg font-bold mb-2">æ–°å¢åŠè»Š</h3>

          <input type="date" className="border w-full p-2 rounded mb-2"
            value={craneForm.date}
            onChange={e => setCraneForm({ ...craneForm, date: e.target.value })}
          />

          <input placeholder="åŠè»Šè¦æ ¼ ä¾‹ï¼š45T"
            className="border w-full p-2 rounded mb-2"
            value={craneForm.spec}
            onChange={e => setCraneForm({ ...craneForm, spec: e.target.value })}
          />

          <input type="number" placeholder="å°æ™‚ HR"
            className="border w-full p-2 rounded mb-2"
            value={craneForm.hr}
            onChange={e => setCraneForm({ ...craneForm, hr: e.target.value })}
          />

          <input placeholder="å‚™è¨»"
            className="border w-full p-2 rounded mb-2"
            value={craneForm.note}
            onChange={e => setCraneForm({ ...craneForm, note: e.target.value })}
          />

          <button className="bg-yellow-600 text-white w-full py-2 rounded" onClick={addCrane}>
            å„²å­˜
          </button>
        </Modal>
      )}

      {modalType === "edit" && editRecord && (
        <Modal onClose={() => setModalType("")}>
          <h3 className="text-lg font-bold mb-2">ç·¨è¼¯ç´€éŒ„</h3>

          <input type="date" className="border w-full p-2 rounded mb-2"
            value={editRecord.date}
            onChange={e => setEditRecord({ ...editRecord, date: e.target.value })}
          />

          {editRecord.type === "labor" ? (
            <>
              <input type="number" placeholder="å¤–åŒ…å·¥"
                className="border w-full p-2 rounded mb-2"
                value={editRecord.labor}
                onChange={e => setEditRecord({ ...editRecord, labor: Number(e.target.value) })}
              />

              <input type="number" placeholder="æ”¯æ´å·¥"
                className="border w-full p-2 rounded mb-2"
                value={editRecord.support}
                onChange={e => setEditRecord({ ...editRecord, support: Number(e.target.value) })}
              />
            </>
          ) : (
            <>
              <input placeholder="åŠè»Šè¦æ ¼"
                className="border w-full p-2 rounded mb-2"
                value={editRecord.spec}
                onChange={e => setEditRecord({ ...editRecord, spec: e.target.value })}
              />

              <input type="number" placeholder="å°æ™‚ HR"
                className="border w-full p-2 rounded mb-2"
                value={editRecord.hr}
                onChange={e => {
                  const hr = Number(e.target.value);
                  const day = parseFloat((hr / 8).toFixed(1));
                  setEditRecord({ ...editRecord, hr, day });
                }}
              />
            </>
          )}

          <input placeholder="å‚™è¨»"
            className="border w-full p-2 rounded mb-2"
            value={editRecord.note}
            onChange={e => setEditRecord({ ...editRecord, note: e.target.value })}
          />

          <button className="bg-green-600 text-white w-full py-2 rounded" onClick={saveEdit}>
            å„²å­˜ä¿®æ”¹
          </button>
        </Modal>
      )}

    </div>
  );
}

/* ======================= ReactDOM Render ======================= */
ReactDOM.createRoot(document.getElementById("root")).render(<App />);

</script>
</body>
</html>
