<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¤–åŒ…å•†å·¥ç¨‹å·¥æ•¸èˆ‡åŠè»Šçµ±è¨ˆç³»çµ±</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.mini.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            table { font-size: 14px; }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen p-4">
    <div id="root"></div>
    <div id="modal-root"></div>

    <script type="text/babel">

/* ======================= LocalStorage Helper ======================= */
const load = (k, f) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : f; } catch { return f; } };
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

/* ======================= Modal Componentï¼ˆå…±ç”¨ï¼‰ ======================= */
function Modal({ onClose, children }) {
    return ReactDOM.createPortal(
        <div className="fixed inset-0 bg-black/40 flex justify-center items-center z-50">
            <div className="bg-white p-4 rounded shadow w-96">
                {children}
                <button className="mt-3 bg-gray-500 text-white w-full rounded py-2" onClick={onClose}>
                    é—œé–‰
                </button>
            </div>
        </div>,
        document.getElementById("modal-root")
    );
}
/***********************************************************
 * App ä¸»ç¨‹å¼
 ***********************************************************/
function App() {

    /* -------------------- å·¥ç¨‹ç®¡ç† -------------------- */
    const [projects, setProjects] = React.useState(load("projects", []));
    const [currentProjectId, setCurrentProjectId] = React.useState(load("currentProjectId", ""));
    const [newProject, setNewProject] = React.useState({ number: "", name: "" });

    /* -------------------- å¤–åŒ…å•†ç®¡ç† -------------------- */
    const [vendors, setVendors] = React.useState(load("vendors", ["ç´˜å±•"]));
    const [currentVendor, setCurrentVendor] = React.useState(load("currentVendor", "ç´˜å±•"));

    /* -------------------- å·¥æ•¸ / åŠè»Šç´€éŒ„ -------------------- */
    const [records, setRecords] = React.useState(load("records", []));

    /* -------------------- é ä¼°å·¥æ•¸ -------------------- */
    const [estimateLabor, setEstimateLabor] = React.useState(load("estimateLabor", ""));

    /* -------------------- é ä¼°åŠè»Šï¼ˆå¯å¤šç­†ï¼‰ -------------------- */
    const [estimateCranes, setEstimateCranes] = React.useState(load("estimateCranes", []));
    const [newEstimateCrane, setNewEstimateCrane] = React.useState({ spec: "", day: "" });

    /* -------------------- Modal æ§åˆ¶ -------------------- */
    const [modalType, setModalType] = React.useState("");Â  Â // labor, crane, edit
    const [laborForm, setLaborForm] = React.useState({ date:"", labor:"", support:"", note:"" });
    const [craneForm, setCraneForm] = React.useState({ date:"", spec:"", hr:"", note:"" });

    /* -------------------- ç·¨è¼¯ (æ•´æ—¥è¨˜éŒ„ç”¨) -------------------- */
    const [editDay, setEditDay] = React.useState(null);Â  Â // { date, labor, support, cranes[] }

    /***********************************************************
     * Auto Save
     ***********************************************************/
    React.useEffect(() => save("projects", projects), [projects]);
    React.useEffect(() => save("currentProjectId", currentProjectId), [currentProjectId]);
    React.useEffect(() => save("vendors", vendors), [vendors]);
    React.useEffect(() => save("currentVendor", currentVendor), [currentVendor]);
    React.useEffect(() => save("records", records), [records]);
    React.useEffect(() => save("estimateLabor", estimateLabor), [estimateLabor]);
    React.useEffect(() => save("estimateCranes", estimateCranes), [estimateCranes]);


    /***********************************************************
     * å·¥ç¨‹ç®¡ç†
     ***********************************************************/
    const addProject = () => {
        if (!newProject.number || !newProject.name) return;

        const id = Date.now().toString();
        setProjects([...projects, { id, ...newProject }]);
        setCurrentProjectId(id);
        setNewProject({ number:"", name:"" });
    };

    const deleteProject = () => {
        if (!currentProjectId) return alert("è«‹å…ˆé¸æ“‡å·¥ç¨‹ï¼");

        const proj = projects.find(p => p.id === currentProjectId);
        if (!proj) return;
        if (!confirm(`ç¢ºå®šåˆªé™¤å·¥ç¨‹ï¼š${proj.number} ${proj.name}ï¼Ÿï¼ˆæ‰€æœ‰ç´€éŒ„æœƒæ¸…ç©ºï¼‰`)) return;

        setProjects(projects.filter(p => p.id !== currentProjectId));
        setRecords(records.filter(r => r.projectId !== currentProjectId));
        setCurrentProjectId("");
    };


    /***********************************************************
     * å¤–åŒ…å•†ç®¡ç†
     ***********************************************************/
    const addVendor = () => {
        const v = prompt("æ–°å¢å¤–åŒ…å•†åç¨±");
        if (!v) return;
        if (!vendors.includes(v)) setVendors([...vendors, v]);
        setCurrentVendor(v);
    };


    /***********************************************************
     * æ–°å¢å·¥æ•¸ç´€éŒ„
     ***********************************************************/
    const addLabor = () => {
        if (!laborForm.date) return alert("è«‹è¼¸å…¥æ—¥æœŸï¼");
        const id = records.length + 1;

        setRecords([
            ...records,
            {
                id,
                type: "labor",
                projectId: currentProjectId,
                vendor: currentVendor,
                date: laborForm.date,
                labor: Number(laborForm.labor || 0),
                support: Number(laborForm.support || 0),
                spec: "",
                hr: 0,
                day: 0,
                note: laborForm.note || ""
            }
        ]);

        setLaborForm({ date:"", labor:"", support:"", note:"" });
        setModalType("");
    };


    /***********************************************************
     * æ–°å¢åŠè»Šç´€éŒ„
     ***********************************************************/
    const addCrane = () => {
        if (!craneForm.date || !craneForm.spec || !craneForm.hr)
            return alert("è«‹å®Œæ•´å¡«å¯«æ¬„ä½");

        const hr = Number(craneForm.hr);
        const day = parseFloat((hr / 8).toFixed(1));
        const id = records.length + 1;

        setRecords([
            ...records,
            {
                id,
                type: "crane",
                projectId: currentProjectId,
                vendor: currentVendor,
                date: craneForm.date,
                spec: craneForm.spec,
                hr,
                day,
                labor: 0,
                support: 0,
                note: craneForm.note || ""
            }
        ]);

        setCraneForm({ date:"", spec:"", hr:"", note:"" });
        setModalType("");
    };
    /***********************************************************
     * ä¾æ—¥æœŸå½™ç¸½ groupedRecords
     ***********************************************************/
    const projectRecords = records
        .filter(r => r.projectId === currentProjectId && r.vendor === currentVendor)
        .sort((a, b) => a.date === b.date ? a.id - b.id : a.date.localeCompare(b.date));

    const groupedRecords = [];

    projectRecords.forEach(r => {
        let day = groupedRecords.find(g => g.date === r.date);
        if (!day) {
            day = {
                date: r.date,
                labor: 0,
                support: 0,
                cranes: [],
                notes: [],
                rawRecords: []
            };
            groupedRecords.push(day);
        }

        day.rawRecords.push(r);

        if (r.type === "labor") {
            day.labor += r.labor;
            day.support += r.support;
            // å‚™è¨»ï¼šå¤šç­†å·¥æ•¸è¨˜éŒ„çš„å‚™è¨»æœƒè¢«æ”¶é›†åˆ° notes é™£åˆ—ä¸­
            if (r.note) day.notes.push(r.note);
        }

        if (r.type === "crane") {
            day.cranes.push({
                id: r.id,
                spec: r.spec,
                hr: r.hr,
                day: r.day,
                note: r.note || ""
            });
        }
    });

    /* --- å·¥æ•¸çµ±è¨ˆï¼ˆä¿ç•™åŸåŠŸèƒ½ï¼‰ --- */
    const totalLabor = groupedRecords.reduce((s, d) => s + d.labor, 0);
    const totalSupport = groupedRecords.reduce((s, d) => s + d.support, 0);
    const totalLaborSum = totalLabor + totalSupport;

    /* --- å·¥æ•¸è½å·®ï¼ˆä¿ç•™ï¼‰ --- */
    const laborDiff = estimateLabor ? Number(estimateLabor) - totalLaborSum : 0;
    const laborDiffColor =
        laborDiff > 0 ? "text-green-600 font-bold"
        : laborDiff < 0 ? "text-red-600 font-bold"
        : "text-gray-600";

    /* --- åŠè»Šçµ±è¨ˆï¼ˆä¿ç•™åŸåŠŸèƒ½ï¼‰ --- */
    const craneStats = {};
    groupedRecords.forEach(day => {
        day.cranes.forEach(c => {
            if (!craneStats[c.spec]) craneStats[c.spec] = 0;
            craneStats[c.spec] += c.day;
        });
    });

    const currentProject = projects.find(p => p.id === currentProjectId);
    const titleText = currentProject
        ? `${currentVendor} - ${currentProject.number} ${currentProject.name} çµ±è¨ˆè¡¨`
        : "å°šæœªé¸æ“‡å·¥ç¨‹";


    /***********************************************************
     * åˆªé™¤æ•´å¤©ç´€éŒ„
     ***********************************************************/
    const deleteDay = (date) => {
        if (!confirm(`ç¢ºå®šåˆªé™¤ ${date} æ‰€æœ‰ç´€éŒ„ï¼Ÿ`)) return;
        setRecords(records.filter(r => !(r.projectId === currentProjectId && r.vendor === currentVendor && r.date === date)));
    };


    /***********************************************************
     * é–‹å•Ÿç·¨è¼¯æŸä¸€å¤©è³‡æ–™
     ***********************************************************/
    const startEditDay = (day) => {
        setEditDay({
            date: day.date,
            // ğŸŒŸ æ³¨æ„ï¼šlabor/support è½‰ç‚ºå­—ä¸²ä»¥ä¾›è¼¸å…¥æ¬„ä½ä½¿ç”¨ï¼Œé¿å… Number è½‰æ›å•é¡Œ
            labor: String(day.labor), 
            support: String(day.support),
            cranes: JSON.parse(JSON.stringify(day.cranes)),
            notesText: day.notes.join("\n") 
        });
        setModalType("editDay");
    }; 
    /***********************************************************
     * æ˜ç´°è¡¨ UIï¼ˆä¸€å¤©åªæœ‰ä¸€åˆ—ï¼‰
     ***********************************************************/
    const DetailTable = () => (
        <div className="overflow-x-auto bg-white rounded shadow mt-4">
            <table className="w-full border text-center">
                <thead className="bg-gray-200">
                    <tr>
                        <th className="border px-2 py-1">æ—¥æœŸ</th>
                        <th className="border px-2 py-1">å¤–åŒ…å·¥</th>
                        <th className="border px-2 py-1">æ”¯æ´å·¥</th>
                        <th className="border px-2 py-1">åŠè»Š</th>
                        <th className="border px-2 py-1">å‚™è¨»</th>
                        <th className="border px-2 py-1 no-print">æ“ä½œ</th>
                    </tr>
                </thead>

                <tbody>
                    {groupedRecords.map(day => (
                        <tr key={day.date}>
                            <td className="border px-2 py-1">{day.date}</td>
                            <td className="border px-2 py-1">{day.labor || ""}</td>
                            <td className="border px-2 py-1">{day.support || ""}</td>

                            <td className="border px-2 py-1 whitespace-pre-line">
                                {(() => {
                                    if (day.cranes.length === 0) return "";

                                    // å½™ç¸½åŒè¦æ ¼çš„ HR
                                    const grouped = {};
                                    day.cranes.forEach(c => {
                                        if (!grouped[c.spec]) grouped[c.spec] = 0;
                                        grouped[c.spec] += c.hr;
                                    });

                                    // è½‰å°æ•¸
                                    return Object.entries(grouped)
                                        .map(([spec, totalHr]) => {
                                            const units = (totalHr / 8).toFixed(1); // å°æ•¸
                                            return `${spec}ï¼ˆ${units}å°ï¼‰`;
                                        })
                                        .join("\n");
                                })()}
                            </td>


                            {/* å‚™è¨»ï¼šå¤šè¡Œ */}
                            <td className="border px-2 py-1 whitespace-pre-line">
                                {day.notes.join("\n")}
                            </td>

                            <td className="border px-2 py-1 no-print">
                                <button className="text-blue-600 mr-2" onClick={() => startEditDay(day)}>ç·¨è¼¯</button>
                                <button className="text-red-600" onClick={() => deleteDay(day.date)}>åˆªé™¤</button>
                            </td>
                        </tr>
                    ))}

                    {/* ä¿ç•™ä½ åŸæœ¬çš„å°è¨ˆåˆ— */}
                    <tr className="bg-yellow-100 font-bold">
                        <td className="border px-2 py-2 text-center" colSpan="1">å·¥æ•¸å°è¨ˆ</td>
                        <td className="border px-2 py-2 text-blue-700">{totalLabor.toFixed(1)}</td>
                        <td className="border px-2 py-2 text-blue-700">{totalSupport.toFixed(1)}</td>
                        <td className="border px-2 py-2" colSpan="3"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    );
/***********************************************************
 * Modalï¼šç·¨è¼¯æ•´å¤©è³‡æ–™ï¼ˆå·¥æ•¸ + åŠè»Šï¼‰
 ***********************************************************/
const EditDayModal = () => {
    // ğŸŒŸ å„ªåŒ–ï¼šå°‡è¤‡é›œçš„ editDay ç‹€æ…‹æ‹†åˆ†ç‚ºå…§éƒ¨ç‹€æ…‹ï¼Œæ¸›å°‘ä¸å¿…è¦çš„ App ç´šåˆ¥é‡æ–°æ¸²æŸ“
    const [tempLabor, setTempLabor] = React.useState(editDay.labor);
    const [tempSupport, setTempSupport] = React.useState(editDay.support);
    const [tempNotes, setTempNotes] = React.useState(editDay.notesText);
    const [tempCranes, setTempCranes] = React.useState(editDay.cranes);

    /* æ›´æ–°æŸä¸€ç­†åŠè»Šé …ç›® */
    const updateCrane = (index, field, value) => {
        setTempCranes(prevCranes => {
            const updated = [...prevCranes];
            const newCrane = { ...updated[index], [field]: value };
            
            // è‹¥ä¿®æ”¹ HR â†’ è‡ªå‹•æ›ç®—å¤©æ•¸
            if (field === "hr") {
                const hr = Number(value || 0);
                newCrane.day = parseFloat((hr / 8).toFixed(1));
            }

            updated[index] = newCrane;
            return updated; // ğŸŒŸ ç¢ºä¿è¿”å›æ–°çš„é™£åˆ—åƒç…§
        });
    };

    /* åˆªé™¤åŠè»Šä¸€ç­† */
    const deleteCrane = (index) => {
        setTempCranes(prevCranes => {
            const updated = [...prevCranes];
            updated.splice(index, 1);
            return updated; // ğŸŒŸ ç¢ºä¿è¿”å›æ–°çš„é™£åˆ—åƒç…§
        });
    };

    /* æ–°å¢åŠè»Š */
    const addCraneRow = () => {
        setTempCranes(prevCranes => [
            ...prevCranes,
            {
                id: Date.now() + Math.random(), 
                spec: "",
                hr: 0,
                day: 0,
                note: ""
            }
        ]);
    };


    /***********************************************************
     * å„²å­˜ä¿®æ”¹ï¼šè¦†è“‹æ•´å¤©æ‰€æœ‰ records
     ***********************************************************/
    const saveDay = () => {
        // 1. å¾å…§éƒ¨ç‹€æ…‹å–å‡ºè³‡æ–™
        const date = editDay.date;
        
        if (!date) return alert("æ—¥æœŸä¸å¯ç©ºç™½");
        if (Number(tempLabor) < 0 || Number(tempSupport) < 0) return alert("å·¥æ•¸ä¸å¾—ç‚ºè² ");

        // 2. éæ¿¾èˆŠç´€éŒ„
        const filtered = records.filter(record => 
            !(record.date === date && record.projectId === currentProjectId && record.vendor === currentVendor)
        );
        
        // 3. å»ºç«‹æ–°çš„ç´€éŒ„é™£åˆ—
        const newRecords = [...filtered];Â 

        // 4. é‡æ–°å¯«å…¥ã€Œå·¥æ•¸ç´€éŒ„ã€
        if (Number(tempLabor) > 0 || Number(tempSupport) > 0 || tempNotes.trim().length > 0) {
            
            const finalNote = tempNotes
                ? tempNotes.split('\n').filter(n => n.trim() !== '').join('ï¼›')
                : '';

            newRecords.push({
                id: Date.now(), 
                type: "labor",
                projectId: currentProjectId,
                vendor: currentVendor,
                date,
                // ğŸŒŸ é—œéµï¼šåœ¨é€™è£¡è½‰å‹ç‚º Number
                labor: Number(tempLabor), 
                support: Number(tempSupport), 
                hr: 0,
                day: 0,
                spec: "",
                note: finalNote
            });
        }

        // 5. å¯«å…¥åŠè»Šç´€éŒ„
        tempCranes.forEach(c => {
            // æ’é™¤è¦æ ¼å’Œ HR çš†ç‚ºç©ºæˆ– 0 çš„é …ç›®
            if (!c.spec && Number(c.hr) === 0) return; 

            newRecords.push({
                id: Date.now() + Math.random(),Â 
                type: "crane",
                projectId: currentProjectId,
                vendor: currentVendor,
                date,
                spec: c.spec,
                // ğŸŒŸ é—œéµï¼šåœ¨é€™è£¡è½‰å‹ç‚º Number
                hr: Number(c.hr),
                day: Number(c.day),
                labor: 0,
                support: 0,
                note: c.note || ""
            });
        });

        // 6. æ›´æ–°ç‹€æ…‹ä¸¦é—œé–‰ Modal
        setRecords(newRecords);
        setModalType("");
        setEditDay(null);
    };


    /***********************************************************
     * Modal UI
     ***********************************************************/
    return (
        <Modal onClose={() => { setModalType(""); setEditDay(null); }}>
            <h2 className="text-xl font-bold mb-3">ç·¨è¼¯ {editDay.date} ç´€éŒ„</h2>

            {/* å·¥æ•¸å€ */}
            <div className="mb-4">
                <label className="font-bold">å¤–åŒ…å·¥</label>
                <input
                    type="number"
                    className="border w-full p-2 rounded mb-2"
                    value={tempLabor}
                    // ğŸŒŸ å„ªåŒ–ï¼šä½¿ç”¨ç¨ç«‹ç‹€æ…‹æ›´æ–°ï¼Œæœ€å–®ç´”çš„å­—ä¸²å‚³é
                    onChange={e => setTempLabor(e.target.value)} 
                />

                <label className="font-bold">æ”¯æ´å·¥</label>
                <input
                    type="number"
                    className="border w-full p-2 rounded mb-2"
                    value={tempSupport}
                    // ğŸŒŸ å„ªåŒ–ï¼šä½¿ç”¨ç¨ç«‹ç‹€æ…‹æ›´æ–°ï¼Œæœ€å–®ç´”çš„å­—ä¸²å‚³é
                    onChange={e => setTempSupport(e.target.value)} 
                />

                {/* å‚™è¨»æ¬„ä½ (notesText) */}
                <label className="font-bold">å‚™è¨»ï¼ˆå¤šç­†å·¥æ•¸æœƒè‡ªå‹•åˆä½µï¼‰</label>
                <textarea
                    className="border w-full p-2 rounded mb-2"
                    rows="2"
                    value={tempNotes ?? ""}
                    // ğŸŒŸ å„ªåŒ–ï¼šä½¿ç”¨ç¨ç«‹ç‹€æ…‹æ›´æ–°ï¼Œæœ€å–®ç´”çš„å­—ä¸²å‚³éï¼Œè§£æ±ºä¸­æ–‡è¼¸å…¥å•é¡Œ
                    onChange={e => setTempNotes(e.target.value)}
                ></textarea>
            </div>

            {/* åŠè»Šå€ */}
            <h3 className="text-lg font-bold mb-2">åŠè»Šæ¸…å–®</h3>

            {tempCranes.length === 0 && (
                <p className="text-gray-500 mb-2">ç›®å‰ç„¡åŠè»Šç´€éŒ„</p>
            )}

            {tempCranes.map((c, index) => (
                <div key={index} className="border p-3 rounded mb-2 bg-gray-50">
                    <div className="flex gap-2">
                        <input
                            className="border p-2 rounded w-28"
                            placeholder="è¦æ ¼ ä¾‹ï¼š25T"
                            value={c.spec}
                            // ğŸŒŸ é—œéµå„ªåŒ–ï¼šåŠè»Šè¦æ ¼æ›´æ–°ï¼Œç¢ºä¿ç‹€æ…‹ä¸å¯è®Š
                            onChange={e => updateCrane(index, "spec", e.target.value)}
                        />

                        <input
                            type="number"
                            className="border p-2 rounded w-20"
                            placeholder="HR"
                            value={c.hr}
                            // ğŸŒŸ é—œéµå„ªåŒ–ï¼šHR æ›´æ–°ï¼Œç¢ºä¿ç‹€æ…‹ä¸å¯è®Š
                            onChange={e => updateCrane(index, "hr", e.target.value)}
                        />

                        <span className="p-2">= {c.day} å¤©</span>

                        <button
                            className="text-red-600 ml-auto"
                            onClick={() => deleteCrane(index)}
                        >
                            åˆªé™¤
                        </button>
                    </div>

                    {/* åŠè»Šå‚™è¨» */}
                    <input
                        className="border w-full p-2 rounded mt-2"
                        placeholder="å‚™è¨»ï¼ˆå¯ç©ºç™½ï¼‰"
                        value={c.note}
                        // ğŸŒŸ é—œéµå„ªåŒ–ï¼šå‚™è¨»æ›´æ–°ï¼Œç¢ºä¿ç‹€æ…‹ä¸å¯è®Š
                        onChange={e => updateCrane(index, "note", e.target.value)}
                    />
                </div>
            ))}

            {/* æ–°å¢åŠè»ŠæŒ‰éˆ• */}
            <button
                className="bg-blue-600 text-white w-full py-2 rounded mb-4"
                onClick={addCraneRow}
            >
                ï¼‹ æ–°å¢åŠè»Š
            </button>

            {/* å„²å­˜æŒ‰éˆ• */}
            <button
                className="bg-green-600 text-white w-full py-2 rounded"
                onClick={saveDay}
            >
                å„²å­˜ä¿®æ”¹
            </button>
        </Modal>
    );
};
/***********************************************************
 * åŒ¯å‡º PDF
 ***********************************************************/
const exportPDF = () => {
    if (!currentProjectId) return alert("è«‹å…ˆé¸æ“‡å·¥ç¨‹ï¼");
    const element = document.getElementById("pdfArea");

    html2pdf()
        .set({
            margin: 5,
            filename: `${titleText}.pdf`,
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
        })
        .from(element)
        .save();
};


/***********************************************************
 * åŒ¯å‡º Excel
 ***********************************************************/
const exportExcel = () => {
    if (!currentProjectId) return alert("è«‹å…ˆé¸æ“‡å·¥ç¨‹ï¼");

    const wb = XLSX.utils.book_new();
    const sheetData = [
        [titleText],
        [],
        ["æ—¥æœŸ", "å¤–åŒ…å·¥", "æ”¯æ´å·¥", "åŠè»Šè¦æ ¼èˆ‡HR", "å‚™è¨»"]
    ];

    // 1. å¯«å…¥æ˜ç´°è³‡æ–™
    groupedRecords.forEach(day => {
        sheetData.push([
            day.date,
            day.labor,
            day.support,
            day.cranes.map(c => `${c.spec} (${c.hr}HR)`).join("\n"),
            day.notes.join("\n")
        ]);
    });

    // 2. å¯«å…¥å¯¦éš›å·¥æ•¸å°è¨ˆ
    sheetData.push([]);
    sheetData.push(["å¯¦éš›å·¥æ•¸å°è¨ˆ"]);
    sheetData.push(["å¤–åŒ…å·¥", totalLabor]);
    sheetData.push(["æ”¯æ´å·¥", totalSupport]);
    sheetData.push(["å·¥æ•¸åˆè¨ˆ", totalLaborSum]);

    // 3. å¯«å…¥é ä¼°å·¥æ•¸å’Œè½å·® 
    sheetData.push([]);
    sheetData.push(["é ä¼°å·¥æ•¸", estimateLabor || "-"]); // <<<< å ±éŒ¯é»
    sheetData.push(["å·¥æ•¸è½å·®(é ä¼°-å¯¦éš›)", laborDiff.toFixed(1)]); 

    // 4. å¯«å…¥é ä¼°åŠè»Š 
    sheetData.push([]);
    sheetData.push(["é ä¼°åŠè»Š"]);
    if (estimateCranes.length > 0) {
        estimateCranes.forEach(c =>
            sheetData.push([c.spec, `${c.day}å¤©`])
        );
    } else {
        sheetData.push(["ç„¡é ä¼°åŠè»Šè³‡æ–™"]);
    }
    
    // 5. å¯«å…¥å¯¦éš›åŠè»Šçµ±è¨ˆ
    sheetData.push([]);
    sheetData.push(["å¯¦éš›åŠè»Šçµ±è¨ˆ"]);
    if (Object.keys(craneStats).length === 0) {
        sheetData.push(["ç„¡å¯¦éš›åŠè»Šè³‡æ–™"]);
    } else {
        Object.entries(craneStats).forEach(([spec, day]) =>
            sheetData.push([spec, `${day.toFixed(1)}å¤©`])
        );
    }


    const ws = XLSX.utils.aoa_to_sheet(sheetData);
    
    // èª¿æ•´æ¬„ä½å¯¬åº¦
    ws["!cols"] = [
        { wch: 12 }, // æ—¥æœŸ
        { wch: 10 }, // å¤–åŒ…å·¥
        { wch: 10 }, // æ”¯æ´å·¥
        { wch: 20 }, // åŠè»Šè¦æ ¼èˆ‡HR
        { wch: 20 }, // å‚™è¨»
        { wch: 15 } // é¡å¤–æ¬„ä½ (ç”¨æ–¼çµ±è¨ˆæ•¸æ“š)
    ];

    XLSX.utils.book_append_sheet(wb, ws, "çµ±è¨ˆ");
    XLSX.writeFile(wb, `${titleText}.xlsx`);
};
/***********************************************************
 * åœ“é¤…åœ– PieChart
 ***********************************************************/
const pieRef = React.useRef(null);
const pieChartRef = React.useRef(null);

React.useEffect(() => {
    if (!pieRef.current) return;

    const ctx = pieRef.current.getContext("2d");

    if (pieChartRef.current) pieChartRef.current.destroy();

    pieChartRef.current = new Chart(ctx, {
        type: "pie",
        data: {
            labels: ["å¤–åŒ…å·¥", "æ”¯æ´å·¥"],
            datasets: [{
                data: [totalLabor, totalSupport],
                backgroundColor: ["#3B82F6", "#FBBF24"]
            }]
        },
        plugins: [ChartDataLabels],
        options: {
            plugins: {
                legend: { position: "bottom" },
                datalabels: {
                    color: "#000",
                    font: { weight: "bold", size: 14 },
                    formatter: (val, ctx) => {
                        const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                        return total === 0 ? "0%" : ((val / total) * 100).toFixed(1) + "%";
                    }
                }
            }
        }
    });
}, [totalLabor, totalSupport]);


/***********************************************************
 * ä¸»ç•«é¢ UI
 ***********************************************************/
return (
    <div className="max-w-full">

        {/* ========= æ¨™é¡Œ ========= */}
        <h1 className="text-2xl font-bold mb-4 text-center">{titleText}</h1>

        {/* ========= å·¥ç¨‹ç®¡ç† ========= */}
        <div className="bg-white p-4 rounded shadow mb-4 no-print">
            <h2 className="font-semibold mb-2">å·¥ç¨‹ç®¡ç†</h2>

            <div className="flex gap-4 items-center mb-2">
                <select
                    className="border p-2 rounded"
                    value={currentProjectId}
                    onChange={e => setCurrentProjectId(e.target.value)}
                >
                    <option value="">è«‹é¸æ“‡å·¥ç¨‹</option>
                    {projects.map(p => (
                        <option key={p.id} value={p.id}>{p.number} - {p.name}</option>
                    ))}
                </select>

                <button
                    className="bg-blue-600 text-white px-4 py-2 rounded"
                    onClick={() => {
                        const num = prompt("å·¥ç¨‹æ¡ˆè™Ÿ");
                        const name = prompt("å·¥ç¨‹åç¨±");
                        if (!num || !name) return;
                        const id = Date.now().toString();
                        setProjects([...projects, { id, number: num, name }]);
                        setCurrentProjectId(id);
                    }}
                >æ–°å¢å·¥ç¨‹</button>

                <button className="bg-red-600 text-white px-4 py-2 rounded" onClick={deleteProject}>
                    åˆªé™¤å·¥ç¨‹
                </button>
            </div>
        </div>

        {/* ========= å¤–åŒ…å•†ç®¡ç† ========= */}
        <div className="bg-white p-4 rounded shadow mb-4 no-print">
            <h2 className="font-semibold mb-2">å¤–åŒ…å•†ç®¡ç†</h2>
            <div className="flex gap-4 items-center mb-2">
                <select
                    className="border p-2 rounded"
                    value={currentVendor}
                    onChange={e => setCurrentVendor(e.target.value)}
                >
                    {vendors.map(v => <option key={v} value={v}>{v}</option>)}
                </select>

                <button className="bg-green-600 text-white px-4 py-2 rounded" onClick={addVendor}>
                    æ–°å¢å¤–åŒ…å•†
                </button>
            </div>
        </div>

        {/* ========= æ“ä½œæŒ‰éˆ• ========= */}
        <div className="flex gap-4 mb-4 no-print">
            <button className="bg-blue-500 text-white px-4 py-2 rounded" onClick={() => setModalType("labor")}>
                æ–°å¢å·¥æ•¸
            </button>

            <button className="bg-yellow-500 text-white px-4 py-2 rounded" onClick={() => setModalType("crane")}>
                æ–°å¢åŠè»Š
            </button>

            <button className="bg-gray-700 text-white px-4 py-2 rounded" onClick={() => window.print()}>
                åˆ—å°
            </button>

            <button className="bg-red-600 text-white px-4 py-2 rounded" onClick={exportPDF}>
                åŒ¯å‡º PDF
            </button>

            <button className="bg-purple-600 text-white px-4 py-2 rounded" onClick={exportExcel}>
                åŒ¯å‡º Excel
            </button>
        </div>

        {/* ========== PDF å€åŸŸï¼ˆæ˜ç´° + çµ±è¨ˆ + åœ“é¤…åœ–ï¼‰ ========== */}
        <div id="pdfArea">

            {/* æ˜ç´°è¡¨ */}
            <DetailTable />

            {/* çµ±è¨ˆ + åœ“é¤…åœ– */}
            <div className="bg-white p-6 rounded shadow mt-6 border flex gap-6">
                <div className="flex-1">
                    <h2 className="text-xl font-bold mb-4">ğŸ“Š çµ±è¨ˆç¸½è¦½</h2>

                    <p className="text-lg">å¤–åŒ…å·¥ï¼š
                        <span className="text-blue-700 font-bold">{totalLabor.toFixed(1)}</span>
                    </p>
                    <p className="text-lg">æ”¯æ´å·¥ï¼š
                        <span className="text-blue-700 font-bold">{totalSupport.toFixed(1)}</span>
                    </p>
                    <p className="text-lg">å·¥æ•¸åˆè¨ˆï¼š
                        <span className="text-red-700 font-bold">{totalLaborSum.toFixed(1)}</span>
                    </p>

                    {/* é ä¼°å·¥æ•¸ */}
                    <div className="mt-4">
                        <h3 className="font-bold mb-1 text-gray-800">â­ é ä¼°å·¥æ•¸</h3>
                        <input
                            type="number"
                            className="border p-2 rounded w-40"
                            placeholder="è¼¸å…¥é ä¼°å·¥æ•¸"
                            value={estimateLabor}
                            onChange={e => setEstimateLabor(e.target.value)}
                        />
                        <p className="mt-2">
                            å·¥æ•¸è½å·®ï¼ˆé ä¼°-å¯¦éš›ï¼‰ï¼š
                            <span className={laborDiffColor}>
                                {laborDiff > 0 ? "+" : ""}{laborDiff.toFixed(1)}
                            </span>
                        </p>
                    </div>

                    {/* é ä¼°åŠè»Š */}
                    <div className="mt-6">
                        <h3 className="font-bold mb-2 text-gray-800">â­ é ä¼°åŠè»Šï¼ˆå¯å¤šç­†ï¼‰</h3>

                        {estimateCranes.length === 0 && <p className="text-gray-500">å°šæœªæ–°å¢é ä¼°åŠè»Š</p>}

                        <div className="space-y-2">
                            {estimateCranes.map((c, idx) => (
                                <div key={idx} className="flex items-center gap-2">
                                    <span>{c.spec}</span>
                                    <span>{c.day} å¤©</span>
                                    <button
                                        className="text-red-600"
                                        onClick={() => {
                                            const copy = [...estimateCranes];
                                            copy.splice(idx, 1);
                                            setEstimateCranes(copy);
                                        }}
                                    >åˆªé™¤</button>
                                </div>
                            ))}
                        </div>

                        <div className="flex gap-2 mt-3">
                            <input
                                placeholder="åŠè»Šè¦æ ¼ ä¾‹ï¼š45T"
                                className="border p-2 rounded w-32"
                                value={newEstimateCrane.spec}
                                onChange={e => setNewEstimateCrane({ ...newEstimateCrane, spec: e.target.value })}
                            />
                            <input
                                type="number"
                                placeholder="å¤©"
                                className="border p-2 rounded w-20"
                                value={newEstimateCrane.day}
                                onChange={e => setNewEstimateCrane({ ...newEstimateCrane, day: e.target.value })}
                            />

                            <button
                                className="bg-blue-600 text-white px-3 rounded"
                                onClick={() => {
                                    if (!newEstimateCrane.spec || !newEstimateCrane.day) return;
                                    setEstimateCranes([
                                        ...estimateCranes,
                                        { spec: newEstimateCrane.spec, day: Number(newEstimateCrane.day) }
                                    ]);
                                    setNewEstimateCrane({ spec: "", day: "" });
                                }}
                            >æ–°å¢</button>
                        </div>
                    </div>

                    {/* åŠè»Šçµ±è¨ˆ */}
                    <h3 className="text-lg font-bold mt-4">åŠè»Šçµ±è¨ˆ</h3>
                    {Object.keys(craneStats).length === 0 && <p>ç„¡åŠè»Šç´€éŒ„</p>}
                    {Object.entries(craneStats).map(([spec, day]) => (
                        <p key={spec}>{spec}ï¼š
                            <span className="text-green-700 font-bold">{day.toFixed(1)} å¤©</span>
                        </p>
                    ))}
                </div>

                {/* åœ“é¤…åœ– */}
                <div className="w-64 h-64 flex justify-center items-center">
                    <canvas ref={pieRef}></canvas>
                </div>
            </div>
        </div>

        {/* =============== æ–°å¢å·¥æ•¸ Modal =============== */}
        {modalType === "labor" && (
            <Modal onClose={() => setModalType("")}>
                <h3 className="text-lg font-bold mb-2">æ–°å¢å·¥æ•¸</h3>

                <input type="date" className="border w-full p-2 rounded mb-2"
                    value={laborForm.date}
                    onChange={e => setLaborForm({ ...laborForm, date: e.target.value })}
                />

                <input type="number" placeholder="å¤–åŒ…å·¥"
                    className="border w-full p-2 rounded mb-2"
                    // ç¢ºä¿è¼¸å…¥é †æš¢ï¼Œåªå‚³éå­—ä¸²
                    value={laborForm.labor}
                    onChange={e => setLaborForm({ ...laborForm, labor: e.target.value })}
                />

                <input type="number" placeholder="æ”¯æ´å·¥"
                    className="border w-full p-2 rounded mb-2"
                    // ç¢ºä¿è¼¸å…¥é †æš¢ï¼Œåªå‚³éå­—ä¸²
                    value={laborForm.support}
                    onChange={e => setLaborForm({ ...laborForm, support: e.target.value })}
                />

                <textarea
                    className="border w-full p-2 rounded mb-2"
                    rows="2"
                    placeholder="å‚™è¨»"
                    value={laborForm.note}
                    onChange={e => setLaborForm({ ...laborForm, note: e.target.value })}
                ></textarea>

                <button className="bg-blue-600 text-white w-full py-2 rounded" onClick={addLabor}>
                    å„²å­˜
                </button>
            </Modal>
        )}

        {/* =============== æ–°å¢åŠè»Š Modal =============== */}
        {modalType === "crane" && (
            <Modal onClose={() => setModalType("")}>
                <h3 className="text-lg font-bold mb-2">æ–°å¢åŠè»Š</h3>

                <input type="date" className="border w-full p-2 rounded mb-2"
                    value={craneForm.date}
                    onChange={e => setCraneForm({ ...craneForm, date: e.target.value })}
                />

                <input placeholder="åŠè»Šè¦æ ¼ ä¾‹ï¼š45T"
                    className="border w-full p-2 rounded mb-2"
                    value={craneForm.spec}
                    // ğŸŒŸ ç¢ºä¿æ›´æ–°ï¼šæœ€å–®ç´”çš„å­—ä¸²å‚³é
                    onChange={e => setCraneForm({ ...craneForm, spec: e.target.value })}
                />

                <input type="number" placeholder="å°æ™‚ HR"
                    className="border w-full p-2 rounded mb-2"
                    // ç¢ºä¿è¼¸å…¥é †æš¢ï¼Œåªå‚³éå­—ä¸²
                    value={craneForm.hr}
                    onChange={e => setCraneForm({ ...craneForm, hr: e.target.value })}
                />

                <input placeholder="å‚™è¨»"
                    className="border w-full p-2 rounded mb-2"
                    value={craneForm.note}
                    // ğŸŒŸ ç¢ºä¿æ›´æ–°ï¼šæœ€å–®ç´”çš„å­—ä¸²å‚³é
                    onChange={(e) => setCraneForm({ ...craneForm, note: e.target.value })}Â 
                />

                <button className="bg-yellow-600 text-white w-full py-2 rounded" onClick={addCrane}>
                    å„²å­˜
                </button>
            </Modal>
        )}

        {/* =============== ç·¨è¼¯æ•´å¤© Modal =============== */}
        {modalType === "editDay" && editDay && (
            <EditDayModal />
        )}

    </div>
);
}Â 
/***********************************************************
 * React DOM Render (React18)
 ***********************************************************/
ReactDOM.createRoot(document.getElementById("root")).render(<App />);

    </script>
</body>
</html>
